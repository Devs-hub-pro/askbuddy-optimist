
<!-- Expert Profile Page -->
<view class="container pb-20">
  <!-- Header with Navigation -->
  <view class="sticky top-0 z-50 bg-app-teal shadow-sm animate-fade-in">
    <view class="flex items-center h-12 px-4">
      <view bindtap="navigateBack" class="text-white">
        <image src="/assets/icons/arrow-left.png" style="width: 24px; height: 24px;" />
      </view>
      <view class="text-white font-medium text-base ml-2">专家主页</view>
      <view class="flex-1"></view>
      <button open-type="share" class="text-white bg-transparent border-0 p-0 m-0 leading-none">
        <image src="/assets/icons/share.png" style="width: 20px; height: 20px;" />
      </button>
    </view>
  </view>

  <block wx:if="{{isLoading}}">
    <!-- Loading Skeleton -->
    <view class="animate-pulse-soft">
      <view class="relative">
        <view class="h-32 bg-gray-200"></view>
        <view class="absolute -bottom-10 left-4 w-20 h-20 rounded-full bg-gray-300 border-4 border-white"></view>
      </view>
      <view class="pt-12 px-4">
        <view class="h-5 bg-gray-200 rounded w-1/2 mb-2"></view>
        <view class="h-4 bg-gray-200 rounded w-2/3 mb-4"></view>
        <view class="flex flex-wrap gap-2 mb-4">
          <view class="h-6 bg-gray-200 rounded-full w-16"></view>
          <view class="h-6 bg-gray-200 rounded-full w-16"></view>
          <view class="h-6 bg-gray-200 rounded-full w-16"></view>
        </view>
        <view class="h-20 bg-gray-200 rounded mb-4"></view>
      </view>
    </view>
  </block>

  <block wx:else>
    <!-- Expert Header -->
    <view class="relative">
      <view class="h-32 bg-gradient-to-r from-app-blue to-app-teal"></view>
      <view class="absolute -bottom-10 left-4 w-20 h-20 rounded-full border-4 border-white overflow-hidden">
        <image src="{{expert.avatar}}" mode="aspectFill" class="w-full h-full" />
      </view>
    </view>

    <!-- Expert Details -->
    <view class="pt-12 px-4">
      <view class="flex justify-between items-start">
        <view class="flex-1">
          <view class="flex items-center gap-2">
            <text class="text-lg font-bold">{{expert.name}}</text>
            <view wx:if="{{expert.verified}}" class="bg-blue-50 text-blue-600 text-xs px-2 py-0.5 rounded-full flex items-center">
              <image src="/assets/icons/badge-check.png" style="width: 12px; height: 12px; margin-right: 2px;" />
              已认证
            </view>
          </view>
          <text class="text-sm text-green-600 block">{{expert.title}}</text>
          <view class="flex items-center text-xs text-gray-600 mt-1">
            <image src="/assets/icons/map-pin.png" style="width: 12px; height: 12px; margin-right: 4px;" />
            <text>{{expert.location}}</text>
            <text class="mx-1.5">•</text>
            <text class="text-gray-400">IP属地 {{expert.location}}</text>
          </view>
        </view>
        <view>
          <button bindtap="toggleFollow" class="{{isFollowing ? 'bg-gray-200 text-gray-700' : 'bg-app-teal text-white'}} px-4 py-1.5 rounded-full text-sm font-medium">
            {{isFollowing ? '已关注' : '关注'}}
          </button>
        </view>
      </view>

      <!-- Expert Statistics -->
      <view class="flex justify-between items-center mt-4 p-3 bg-gray-50 rounded-lg">
        <view class="text-center">
          <view class="flex items-center justify-center text-yellow-500">
            <image src="/assets/icons/star.png" style="width: 16px; height: 16px; margin-right: 2px;" />
            <text class="font-medium">{{expert.rating}}</text>
          </view>
          <text class="text-xs text-gray-500">评分</text>
        </view>
        <view class="text-center">
          <view class="flex items-center justify-center text-blue-500">
            <image src="/assets/icons/clock.png" style="width: 16px; height: 16px; margin-right: 2px;" />
            <text>{{expert.responseRate}}</text>
          </view>
          <text class="text-xs text-gray-500">响应率</text>
        </view>
        <view class="text-center">
          <view class="flex items-center justify-center text-green-500">
            <image src="/assets/icons/package.png" style="width: 16px; height: 16px; margin-right: 2px;" />
            <text>{{expert.orderCount}}</text>
          </view>
          <text class="text-xs text-gray-500">完成订单</text>
        </view>
      </view>

      <!-- Expert Topics -->
      <view class="mt-4">
        <view class="flex justify-between items-center mb-2">
          <text class="font-medium text-gray-800">擅长话题</text>
        </view>
        <scroll-view scroll-x="true" class="whitespace-nowrap">
          <view class="inline-flex gap-2 py-2">
            <block wx:for="{{expert.topics}}" wx:key="*this">
              <view class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full text-sm whitespace-nowrap">
                {{item}}
              </view>
            </block>
          </view>
        </scroll-view>
      </view>

      <!-- Expert Description -->
      <view class="mt-4">
        <view class="flex justify-between items-center mb-2">
          <text class="font-medium text-gray-800">个人介绍</text>
        </view>
        <view class="bg-gray-50 p-3 rounded-lg">
          <text class="text-sm text-gray-700 {{isDescriptionExpanded ? '' : 'line-clamp-6'}}">{{expert.description}}</text>
          <view wx:if="{{expert.description.length > 120}}" class="mt-2">
            <view bindtap="toggleDescription" class="text-blue-500 text-xs flex items-center">
              <text>{{isDescriptionExpanded ? '收起' : '展开全部'}}</text>
              <image src="{{isDescriptionExpanded ? '/assets/icons/chevron-up.png' : '/assets/icons/chevron-down.png'}}" style="width: 12px; height: 12px; margin-left: 2px;" />
            </view>
          </view>
        </view>
      </view>

      <!-- Tabs -->
      <view class="mt-6 border-b border-gray-200">
        <view class="flex space-x-6">
          <view 
            bindtap="switchTab" 
            data-tab="resume"
            class="pb-2 relative {{activeTab === 'resume' ? 'text-app-text font-bold' : 'text-gray-500'}}"
          >
            履历
            <view wx:if="{{activeTab === 'resume'}}" class="absolute bottom-0 left-0 right-0 h-0.5 bg-app-blue"></view>
          </view>
          <view 
            bindtap="switchTab" 
            data-tab="answers"
            class="pb-2 relative {{activeTab === 'answers' ? 'text-app-text font-bold' : 'text-gray-500'}}"
          >
            回答
            <view wx:if="{{activeTab === 'answers'}}" class="absolute bottom-0 left-0 right-0 h-0.5 bg-app-blue"></view>
          </view>
          <view 
            bindtap="switchTab" 
            data-tab="questions"
            class="pb-2 relative {{activeTab === 'questions' ? 'text-app-text font-bold' : 'text-gray-500'}}"
          >
            问题
            <view wx:if="{{activeTab === 'questions'}}" class="absolute bottom-0 left-0 right-0 h-0.5 bg-app-blue"></view>
          </view>
          <view 
            bindtap="switchTab" 
            data-tab="reviews"
            class="pb-2 relative {{activeTab === 'reviews' ? 'text-app-text font-bold' : 'text-gray-500'}}"
          >
            用户评价
            <view wx:if="{{activeTab === 'reviews'}}" class="absolute bottom-0 left-0 right-0 h-0.5 bg-app-blue"></view>
          </view>
        </view>
      </view>

      <!-- Tab Contents -->
      <view class="mt-4">
        <!-- Resume Tab -->
        <view wx:if="{{activeTab === 'resume'}}" class="animate-fade-in">
          <view class="mb-6">
            <text class="text-sm font-medium text-gray-700 mb-2 block">教育经历</text>
            <view class="space-y-2">
              <block wx:for="{{expert.education}}" wx:key="*this">
                <view class="bg-blue-50 text-blue-700 text-sm px-3 py-2 rounded-md">
                  {{item}}
                </view>
              </block>
            </view>
          </view>
          <view>
            <text class="text-sm font-medium text-gray-700 mb-2 block">工作经历</text>
            <view class="space-y-2">
              <block wx:for="{{expert.experience}}" wx:key="*this">
                <view class="bg-purple-50 text-purple-700 text-sm px-3 py-2 rounded-md">
                  {{item}}
                </view>
              </block>
            </view>
          </view>
        </view>

        <!-- Answers Tab -->
        <view wx:if="{{activeTab === 'answers'}}" class="animate-fade-in">
          <view class="text-center py-8 text-gray-500">
            <image src="/assets/icons/message-square.png" style="width: 40px; height: 40px; margin: 0 auto 8px;" />
            <text>暂无回答记录</text>
          </view>
        </view>

        <!-- Questions Tab -->
        <view wx:if="{{activeTab === 'questions'}}" class="animate-fade-in">
          <view class="text-center py-8 text-gray-500">
            <image src="/assets/icons/help-circle.png" style="width: 40px; height: 40px; margin: 0 auto 8px;" />
            <text>暂无提问记录</text>
          </view>
        </view>

        <!-- Reviews Tab -->
        <view wx:if="{{activeTab === 'reviews'}}" class="animate-fade-in">
          <block wx:if="{{reviews.length > 0}}">
            <view class="space-y-4">
              <block wx:for="{{reviews}}" wx:key="id">
                <view class="bg-white p-3 rounded-lg shadow-sm">
                  <view class="flex justify-between items-start mb-2">
                    <view class="flex items-center">
                      <image src="{{item.author.avatar}}" class="w-8 h-8 rounded-full mr-2" mode="aspectFill" />
                      <view>
                        <text class="font-medium text-sm">{{item.author.name}}</text>
                        <view class="flex">
                          <block wx:for="{{item.rating}}" wx:for-item="star" wx:key="*this">
                            <image src="/assets/icons/star.png" style="width: 12px; height: 12px;" />
                          </block>
                        </view>
                      </view>
                    </view>
                    <text class="text-xs text-gray-500">{{item.time}}</text>
                  </view>
                  <text class="text-sm text-gray-700">{{item.content}}</text>
                </view>
              </block>
            </view>
          </block>
          <block wx:else>
            <view class="text-center py-8 text-gray-500">
              <image src="/assets/icons/star.png" style="width: 40px; height: 40px; margin: 0 auto 8px;" />
              <text>暂无评价记录</text>
            </view>
          </block>
        </view>
      </view>
    </view>
  </block>

  <!-- Fixed Bottom Actions -->
  <view class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 flex gap-3">
    <button bindtap="showMessageDialog" class="flex-1 py-2 bg-white border border-app-teal text-app-teal rounded-full text-sm font-medium flex items-center justify-center">
      <image src="/assets/icons/mail.png" style="width: 16px; height: 16px; margin-right: 4px;" />
      给TA留言
    </button>
    <button bindtap="showBookingDialog" class="flex-1 py-2 bg-gradient-to-r from-app-teal to-app-blue text-white rounded-full text-sm font-medium flex items-center justify-center">
      <image src="/assets/icons/calendar.png" style="width: 16px; height: 16px; margin-right: 4px;" class="invert" />
      预约问问
    </button>
  </view>

  <!-- Message Dialog -->
  <view class="dialog-mask {{showMessageDialog ? 'show' : ''}}" catchtap="hideMessageDialog">
    <view class="dialog-container" catchtap="preventBubble">
      <view class="dialog-header">
        <text class="dialog-title">给 {{expert.name}} 留言</text>
        <view class="dialog-close" catchtap="hideMessageDialog">
          <image src="/assets/icons/x.png" style="width: 20px; height: 20px;" />
        </view>
      </view>
      <view class="dialog-content">
        <textarea 
          placeholder="请输入留言内容..." 
          class="dialog-textarea" 
          bindinput="handleMessageInput"
          value="{{messageText}}"
        ></textarea>
        <view class="limit-hint">
          <text class="text-xs text-gray-500">最多200字</text>
        </view>
        <button bindtap="sendMessage" class="dialog-button">发送留言</button>
      </view>
    </view>
  </view>

  <!-- Booking Dialog -->
  <view class="dialog-mask {{showBookingDialog ? 'show' : ''}}" catchtap="hideBookingDialog">
    <view class="dialog-container" catchtap="preventBubble">
      <view class="dialog-header">
        <text class="dialog-title">预约 {{expert.name}}</text>
        <view class="dialog-close" catchtap="hideBookingDialog">
          <image src="/assets/icons/x.png" style="width: 20px; height: 20px;" />
        </view>
      </view>
      <view class="dialog-content">
        <view class="mb-4">
          <text class="text-sm font-medium mb-2 block">选择话题</text>
          <scroll-view scroll-x="true" class="whitespace-nowrap">
            <view class="inline-flex gap-2 py-2">
              <block wx:for="{{expert.topics}}" wx:key="*this">
                <view class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full text-sm whitespace-nowrap">
                  {{item}}
                </view>
              </block>
            </view>
          </scroll-view>
        </view>
        <view class="mb-4">
          <text class="text-sm font-medium mb-2 block">选择时间段</text>
          <view class="grid grid-cols-3 gap-2">
            <block wx:for="{{availableTimes}}" wx:key="id">
              <view 
                bindtap="selectTime" 
                data-id="{{item.id}}"
                class="border {{selectedTime === item.id ? 'border-app-teal bg-app-teal/10 text-app-teal' : 'border-gray-200 text-gray-700'}} rounded-md py-2 text-center text-sm"
              >
                {{item.label}}
              </view>
            </block>
          </view>
        </view>
        <view class="mb-4">
          <text class="text-sm font-medium mb-2 block">咨询方式</text>
          <view class="flex gap-2">
            <view 
              bindtap="selectConsultType" 
              data-type="text"
              class="flex-1 border {{selectedConsultType === 'text' ? 'border-app-teal bg-app-teal/10 text-app-teal' : 'border-gray-200 text-gray-700'}} rounded-md py-2 text-center text-sm flex items-center justify-center"
            >
              <image src="{{selectedConsultType === 'text' ? '/assets/icons/message-square-active.png' : '/assets/icons/message-square.png'}}" style="width: 16px; height: 16px; margin-right: 4px;" />
              文字
            </view>
            <view 
              bindtap="selectConsultType" 
              data-type="voice"
              class="flex-1 border {{selectedConsultType === 'voice' ? 'border-app-teal bg-app-teal/10 text-app-teal' : 'border-gray-200 text-gray-700'}} rounded-md py-2 text-center text-sm flex items-center justify-center"
            >
              <image src="{{selectedConsultType === 'voice' ? '/assets/icons/mic-active.png' : '/assets/icons/mic.png'}}" style="width: 16px; height: 16px; margin-right: 4px;" />
              语音
            </view>
            <view 
              bindtap="selectConsultType" 
              data-type="video"
              class="flex-1 border {{selectedConsultType === 'video' ? 'border-app-teal bg-app-teal/10 text-app-teal' : 'border-gray-200 text-gray-700'}} rounded-md py-2 text-center text-sm flex items-center justify-center"
            >
              <image src="{{selectedConsultType === 'video' ? '/assets/icons/video-active.png' : '/assets/icons/video.png'}}" style="width: 16px; height: 16px; margin-right: 4px;" />
              视频
            </view>
          </view>
        </view>
        <button bindtap="confirmBooking" class="dialog-button">确认预约</button>
      </view>
    </view>
  </view>
</view>
