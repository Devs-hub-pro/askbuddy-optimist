<view class="container">
  <!-- Header with tabs -->
  <view class="header-container">
    <view class="status-bar"></view>
    <view class="header">
      <view class="tabs-container">
        <view class="tab {{activeTab === 'chats' ? 'active' : ''}}" bindtap="switchTab" data-tab="chats">
          <text>ç§ä¿¡</text>
        </view>
        <view class="tab {{activeTab === 'group' ? 'active' : ''}}" bindtap="switchTab" data-tab="group">
          <text>ç¤¾ç¾¤æ¶ˆæ¯</text>
          <view wx:if="{{unreadGroupMessages > 0}}" class="unread-badge">{{unreadGroupMessages > 99 ? '99+' : unreadGroupMessages}}</view>
        </view>
        <view class="tab {{activeTab === 'notifications' ? 'active' : ''}}" bindtap="switchTab" data-tab="notifications">
          <text>é€šçŸ¥</text>
          <view wx:if="{{unreadNotifications > 0}}" class="unread-badge">{{unreadNotifications > 99 ? '99+' : unreadNotifications}}</view>
        </view>
      </view>
      <view class="header-actions">
        <view class="search-icon" bindtap="toggleSearch">
          <text class="icon">ğŸ”</text>
        </view>
        <view class="settings-icon" bindtap="openSettings">
          <text class="icon">âš™ï¸</text>
        </view>
      </view>
    </view>
    
    <!-- Search bar (initially hidden) -->
    <view class="search-container {{showSearch ? 'visible' : ''}}">
      <input class="search-input" placeholder="æœç´¢è”ç³»äººæˆ–æ¶ˆæ¯å†…å®¹" confirm-type="search" bindinput="onSearchInput" />
      <view class="cancel-search" bindtap="toggleSearch">å–æ¶ˆ</view>
    </view>
  </view>

  <!-- Chat/Message List Section -->
  <view class="content-container {{showSearch ? 'with-search' : ''}}">
    <!-- Chats tab content -->
    <view class="tab-content {{activeTab === 'chats' ? 'active' : ''}}">
      <view wx:if="{{filteredChats.length === 0 && searchQuery}}" class="empty-state">
        <text>æœªæ‰¾åˆ°ä¸"{{searchQuery}}"ç›¸å…³çš„èŠå¤©</text>
      </view>
      <view wx:elif="{{filteredChats.length === 0}}" class="empty-state">
        <text>æš‚æ— ç§ä¿¡æ¶ˆæ¯</text>
        <view class="empty-action" bindtap="startNewChat">å‘èµ·æ–°çš„ç§ä¿¡</view>
      </view>
      
      <!-- Pinned chats -->
      <block wx:if="{{pinnedChats.length > 0 && !searchQuery}}">
        <view class="section-title">ç½®é¡¶ä¼šè¯</view>
        <view class="chat-list">
          <view wx:for="{{pinnedChats}}" wx:key="id" 
                class="chat-item {{item.unread ? 'unread' : ''}}" 
                bindtap="openChat" data-id="{{item.id}}"
                bindlongpress="showChatOptions" data-id="{{item.id}}"
                data-pinned="true">
            <view class="chat-avatar">
              <image src="{{item.avatar}}" mode="aspectFill"></image>
              <view wx:if="{{item.online}}" class="online-indicator"></view>
            </view>
            <view class="chat-info">
              <view class="chat-header">
                <text class="chat-name">{{item.name}}</text>
                <text class="chat-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="chat-message-preview">
                <text class="message-type" wx:if="{{item.lastMessageType !== 'text'}}">
                  [{{item.lastMessageType === 'image' ? 'å›¾ç‰‡' : 
                     item.lastMessageType === 'voice' ? 'è¯­éŸ³' : 
                     item.lastMessageType === 'file' ? 'æ–‡ä»¶' : 'æ¶ˆæ¯'}}]
                </text>
                <text class="message-content">{{item.lastMessage}}</text>
              </view>
            </view>
            <view wx:if="{{item.unreadCount > 0}}" class="unread-count">
              {{item.unreadCount > 99 ? '99+' : item.unreadCount}}
            </view>
            <view class="pinned-indicator">ğŸ“Œ</view>
          </view>
        </view>
      </block>
      
      <!-- Regular chats -->
      <block wx:if="{{!searchQuery || filteredChats.length > 0}}">
        <view class="section-title" wx:if="{{pinnedChats.length > 0 && !searchQuery}}">æœ€è¿‘ä¼šè¯</view>
        <view class="chat-list">
          <view wx:for="{{filteredChats}}" wx:key="id" 
                class="chat-item {{item.unread ? 'unread' : ''}}" 
                bindtap="openChat" data-id="{{item.id}}"
                bindlongpress="showChatOptions" data-id="{{item.id}}"
                data-pinned="false"
                catch:touchstart="touchStart" catch:touchmove="touchMove" catch:touchend="touchEnd"
                data-index="{{index}}">
            <view class="chat-avatar">
              <image src="{{item.avatar}}" mode="aspectFill"></image>
              <view wx:if="{{item.online}}" class="online-indicator"></view>
            </view>
            <view class="chat-info">
              <view class="chat-header">
                <text class="chat-name">{{item.name}}</text>
                <text class="chat-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="chat-message-preview">
                <text class="message-type" wx:if="{{item.lastMessageType !== 'text'}}">
                  [{{item.lastMessageType === 'image' ? 'å›¾ç‰‡' : 
                     item.lastMessageType === 'voice' ? 'è¯­éŸ³' : 
                     item.lastMessageType === 'file' ? 'æ–‡ä»¶' : 'æ¶ˆæ¯'}}]
                </text>
                <text class="message-content">{{item.lastMessage}}</text>
              </view>
            </view>
            <view wx:if="{{item.unreadCount > 0}}" class="unread-count">
              {{item.unreadCount > 99 ? '99+' : item.unreadCount}}
            </view>
            
            <!-- Swipe actions -->
            <view class="swipe-actions" style="right: {{item.swipeOffset}}px">
              <view class="swipe-action archive" bindtap="archiveChat" data-id="{{item.id}}">å­˜æ¡£</view>
              <view class="swipe-action delete" bindtap="showDeleteConfirm" data-id="{{item.id}}">åˆ é™¤</view>
            </view>
          </view>
        </view>
      </block>
    </view>
    
    <!-- Group tab content -->
    <view class="tab-content {{activeTab === 'group' ? 'active' : ''}}">
      <view wx:if="{{filteredGroupMessages.length === 0 && searchQuery}}" class="empty-state">
        <text>æœªæ‰¾åˆ°ä¸"{{searchQuery}}"ç›¸å…³çš„ç¤¾ç¾¤æ¶ˆæ¯</text>
      </view>
      <view wx:elif="{{filteredGroupMessages.length === 0}}" class="empty-state">
        <text>æš‚æ— ç¤¾ç¾¤æ¶ˆæ¯</text>
      </view>
      <block wx:if="{{filteredGroupMessages.length > 0}}">
        <view class="chat-list">
          <view wx:for="{{filteredGroupMessages}}" wx:key="id"
            class="chat-item {{item.unread ? 'unread' : ''}}"
            bindtap="openGroupMessage" data-id="{{item.id}}"
            bindlongpress="showGroupOptions" data-id="{{item.id}}">
            <view class="chat-avatar">
              <image src="{{item.avatar}}" mode="aspectFill"></image>
            </view>
            <view class="chat-info">
              <view class="chat-header">
                <text class="chat-name">{{item.name}}</text>
                <text class="chat-time">{{item.lastMessageTime}}</text>
              </view>
              <view class="chat-message-preview">
                <text class="message-type" wx:if="{{item.lastMessageType !== 'text'}}">
                  [{{item.lastMessageType === 'image' ? 'å›¾ç‰‡' : 
                     item.lastMessageType === 'file' ? 'æ–‡ä»¶' : 'æ¶ˆæ¯'}}]
                </text>
                <text class="message-content">{{item.lastMessage}}</text>
              </view>
            </view>
            <view wx:if="{{item.unreadCount > 0}}" class="unread-count">
              {{item.unreadCount > 99 ? '99+' : item.unreadCount}}
            </view>
          </view>
        </view>
      </block>
    </view>
    
    <!-- Notifications tab content -->
    <view class="tab-content {{activeTab === 'notifications' ? 'active' : ''}}">
      <view wx:if="{{filteredNotifications.length === 0 && searchQuery}}" class="empty-state">
        <text>æœªæ‰¾åˆ°ä¸"{{searchQuery}}"ç›¸å…³çš„é€šçŸ¥</text>
      </view>
      <view wx:elif="{{filteredNotifications.length === 0}}" class="empty-state">
        <text>æš‚æ— é€šçŸ¥</text>
      </view>
      
      <view wx:else class="notifications-header">
        <view class="mark-all" bindtap="markAllAsRead">å…¨éƒ¨æ ‡ä¸ºå·²è¯»</view>
      </view>
      
      <!-- Transaction notifications -->
      <block wx:if="{{transactionNotifications.length > 0}}">
        <view class="section-title">äº¤æ˜“é€šçŸ¥</view>
        <view class="notification-list">
          <view wx:for="{{transactionNotifications}}" wx:key="id"
                class="notification-item {{item.read ? '' : 'unread'}}"
                bindtap="openNotification" data-id="{{item.id}}" data-type="transaction"
                bindlongpress="showNotificationOptions" data-id="{{item.id}}">
            <view class="notification-icon transaction">ğŸ’°</view>
            <view class="notification-content">
              <view class="notification-title">{{item.title}}</view>
              <view class="notification-message">{{item.message}}</view>
              <view class="notification-time">{{item.time}}</view>
            </view>
            <view wx:if="{{!item.read}}" class="unread-indicator"></view>
          </view>
        </view>
      </block>
      
      <!-- Activity notifications -->
      <block wx:if="{{activityNotifications.length > 0}}">
        <view class="section-title">æ´»åŠ¨é€šçŸ¥</view>
        <view class="notification-list">
          <view wx:for="{{activityNotifications}}" wx:key="id"
                class="notification-item {{item.read ? '' : 'unread'}}"
                bindtap="openNotification" data-id="{{item.id}}" data-type="activity"
                bindlongpress="showNotificationOptions" data-id="{{item.id}}">
            <view class="notification-icon activity">ğŸ‰</view>
            <view class="notification-content">
              <view class="notification-title">{{item.title}}</view>
              <view class="notification-message">{{item.message}}</view>
              <view class="notification-time">{{item.time}}</view>
            </view>
            <view wx:if="{{!item.read}}" class="unread-indicator"></view>
          </view>
        </view>
      </block>
      
      <!-- Interaction notifications -->
      <block wx:if="{{interactionNotifications.length > 0}}">
        <view class="section-title">äº’åŠ¨é€šçŸ¥</view>
        <view class="notification-list">
          <view wx:for="{{interactionNotifications}}" wx:key="id"
                class="notification-item {{item.read ? '' : 'unread'}}"
                bindtap="openNotification" data-id="{{item.id}}" data-type="interaction"
                bindlongpress="showNotificationOptions" data-id="{{item.id}}">
            <view class="notification-icon interaction">ğŸ’¬</view>
            <view class="notification-content">
              <view class="notification-title">{{item.title}}</view>
              <view class="notification-message">{{item.message}}</view>
              <view class="notification-time">{{item.time}}</view>
            </view>
            <view wx:if="{{!item.read}}" class="unread-indicator"></view>
          </view>
        </view>
      </block>
      
      <!-- System notifications -->
      <block wx:if="{{systemNotifications.length > 0}}">
        <view class="section-title">ç³»ç»Ÿå…¬å‘Š</view>
        <view class="notification-list">
          <view wx:for="{{systemNotifications}}" wx:key="id"
                class="notification-item {{item.read ? '' : 'unread'}}"
                bindtap="openNotification" data-id="{{item.id}}" data-type="system"
                bindlongpress="showNotificationOptions" data-id="{{item.id}}">
            <view class="notification-icon system">ğŸ””</view>
            <view class="notification-content">
              <view class="notification-title">{{item.title}}</view>
              <view class="notification-message">{{item.message}}</view>
              <view class="notification-time">{{item.time}}</view>
            </view>
            <view wx:if="{{!item.read}}" class="unread-indicator"></view>
          </view>
        </view>
      </block>
    </view>
  </view>
  
  <!-- Context Menu for longpress actions -->
  <view class="context-menu {{showContextMenu ? 'visible' : ''}}" style="top: {{contextMenuTop}}px; left: {{contextMenuLeft}}px">
    <view class="context-menu-item" wx:if="{{contextMenuType === 'chat' && !contextMenuIsPinned}}" bindtap="pinChat">
      <text>ğŸ“Œ ç½®é¡¶ä¼šè¯</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'chat' && contextMenuIsPinned}}" bindtap="unpinChat">
      <text>ğŸ“Œ å–æ¶ˆç½®é¡¶</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'chat' && contextMenuHasUnread}}" bindtap="markChatAsRead">
      <text>âœ“ æ ‡ä¸ºå·²è¯»</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'chat' && !contextMenuHasUnread}}" bindtap="markChatAsUnread">
      <text>â—‹ æ ‡ä¸ºæœªè¯»</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'chat'}}" bindtap="archiveChat">
      <text>ğŸ“‚ å­˜æ¡£ä¼šè¯</text>
    </view>
    <view class="context-menu-item" bindtap="showDeleteConfirm">
      <text>ğŸ—‘ï¸ åˆ é™¤</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'notification' && !contextMenuIsRead}}" bindtap="markNotificationAsRead">
      <text>âœ“ æ ‡ä¸ºå·²è¯»</text>
    </view>
    <view class="context-menu-item" wx:if="{{contextMenuType === 'notification' && contextMenuIsRead}}" bindtap="markNotificationAsUnread">
      <text>â—‹ æ ‡ä¸ºæœªè¯»</text>
    </view>
  </view>
  
  <!-- Overlay for the context menu and confirmation dialogs -->
  <view class="overlay {{showOverlay ? 'visible' : ''}}" bindtap="hideOverlay"></view>
  
  <!-- Delete confirmation dialog -->
  <view class="dialog {{showDeleteConfirm ? 'visible' : ''}}">
    <view class="dialog-title">ç¡®è®¤åˆ é™¤</view>
    <view class="dialog-content">
      <text>åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œç¡®è®¤åˆ é™¤å—ï¼Ÿ</text>
    </view>
    <view class="dialog-buttons">
      <view class="dialog-button cancel" bindtap="cancelDelete">å–æ¶ˆ</view>
      <view class="dialog-button confirm" bindtap="confirmDelete">åˆ é™¤</view>
    </view>
  </view>
</view>
